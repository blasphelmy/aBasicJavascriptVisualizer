<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      src="https://code.jquery.com/jquery-3.6.0.js"
      integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
      crossorigin="anonymous"
    ></script>

    <script src="lib/codemirror.js"></script>
    <link rel="stylesheet" href="lib/codemirror.css">
    <link rel="stylesheet" href="theme/material-palenight.css">
    <script src="javascript/javascript.js"></script>

    <script src="objects.js"></script>
    <script src="tools.js"></script>
    <script src="regexDefinitions.js"></script>
    <script src="handlers.js"></script>
    <link rel="stylesheet" href="style.css" />

    <title>parse</title>
  </head>
  <body>
<textarea textarea id="code" name="code" style="position:relative; width: 100%; height: 400px">
  var a = 10;
  function b(){
    a = 5;  
    c();
    console.log(d);
  }
  function c(){
    d = 6;
    var a = 7;
    e = 9;
    function f(){
      a = 2;
    }
    f();
  }
  b();
</textarea>
<textarea id = "displayTree">

</textarea>
<button id="runBtn" onclick="initParse()">Run Code</button>
</div>

<div id="outputSection"></div>
</body>

  <script>
var editor = null;
window.addEventListener("load", function(e){
  editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        theme: "material-palenight",
        matchBrackets: true,
        continueComments: "Enter",
        extraKeys: {"Ctrl-Q": "toggleComment"},
      });
});
function initParse() {
  console.clear();
  //step 1, we get javascript code from user as a raw string.
  var inputString = editor.getValue() + ";";
  //now we split the inputString into its induvidual components
  statements = breakIntoComponents(inputString);
  //findEOFLine(statements, 0);
  //console.log(findEOFLine(statements, 0));
  var newFunction = new functionDEF("Global", 0, statements.length);

  console.log(statements);

  var FinalFrame = parseArray(0,statements, new frame(newFunction, statements.length));
  console.log(FinalFrame);
}

function parseArray(start, array, Frame) {
  //var Frame = newFrameObject;
  // console.log("current frame: ", Frame.returnParentFrame());
  for (var index = Frame.start; index <= Frame.end; index++) {
   console.log("index ", index);
    //DETECT FUNCTION DECLATION TOKEN
   if (isFunctionDeclarion(array[index])) {
      index = functionDeclaredHandler(index, array, Frame);
      //DETECT VARIABLE DECLATION TOKEN
    } else if (isVarDeclartion(array[index])) {
      index = variableDeclarationHandler(index, array, Frame);
      //DETECT VARIABLE REASSIGNMENT
    }else if(detectStatementVariableReassignment(array[index])){
      // console.log("variable reassigbment on line ", index);
      // console.log(array[index]);
      var tempArray = array[index].split("=");
      var variableName = tempArray[0].trim();
      var expression = tempArray[1].split(";");
      expression = expression[0];
      var newFrame = returnFrameContainingVariable(Frame, variableName);
      newFrame.variables.set(variableName, eval(expression));
      //console.log(newFrame.id);
    }
    else if(detectFunctionCalls(array[index])){
      var originFrame = returnFrameContainingFunctionDEF(Frame, array[index]);
      if(originFrame.returnFunctionDefinitions(array[index])){
      var newFunctionDef = originFrame.returnFunctionDefinitions(array[index]);
      var newFrame = new frame(newFunctionDef, index);
      newFrame.previousNodeFrame = originFrame;
      originFrame.addChildFrame(newFrame);
      parseArray(newFunctionDef.getStart, array, newFrame);
      }else{
        return "on line " + index + " error: function definition doesn't exist!";
      }
    }
  }
  if(Frame.id === "Global"){
    return Frame;
  }
}
function variableDeclarationHandler(index, array, Frame){
      //console.log("is variable declartion at index: " + index);
      var keyValuePair = array[index+1].split("=");
      keyValuePair[0] = keyValuePair[0].trim();
      
      var variableName = keyValuePair[0];
      var expression = keyValuePair[1];

      expression = breakExpressionIntoComponents(expression);

      // console.log(expression);
      
      var newVarible = new variable(keyValuePair[0], eval(keyValuePair[1])); //cheater!
      Frame.addVariables(newVarible);
      index++;
      return index;
}
function assignExpressionObjects(newComponentsArray){

}
function returnFunction(array) {}
  </script>
</html>
